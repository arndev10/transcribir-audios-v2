# ARCHITECTURE.md

## Project Overview

This project is a **body fat and weight monitoring application** focused on helping users interpret their physical progress over time.

The core goal is **not weight loss itself**, but understanding how body fat, inflammation, retention of liquids, and consistency affect perceived progress.

The system prioritizes:

- long-term trends over daily fluctuations
- explainability over prescriptions
- user-controlled analysis over automatic processing

---

## Core Principles

1. **Weight is not truth**
    
    Daily weight is treated as a noisy signal, not a definitive metric.
    
2. **Body fat is estimated, not asserted**
    
    All body fat values are represented as ranges and marked as approximations.
    
3. **IA supports decisions, it does not make them**
    
    The system controls when and how AI is used. AI never drives system flow.
    
4. **Feedback is generated on demand**
    
    Expensive or heavy processes are triggered explicitly by the user.
    
5. **Everything is explainable**
    
    Every decision taken by the system can be explained through persisted data.
    

---

## High-Level Architecture

```
Frontend (Next.js)
        |
        v
BackendAPI(FastAPI)
        |
        v
DomainLogic(business rules)
        |
        v
Database(SQLite → PostgreSQL)
        |
        v
BackgroundWorkers(AI / analysis jobs)

```

Responsibilities are strictly separated:

- Frontend: presentation and user interaction
- API layer: request validation and orchestration
- Domain layer: business rules and decisions
- Services layer: external integrations (AI, storage)
- Workers: asynchronous processing

---

## Backend Folder Structure

```
backend/
└── app/
    ├── main.py# FastAPI entrypoint
    ├── config.py# environment & settings

    ├── api/# HTTP layer only
    │   ├── routes/
    │   │   ├── auth.py
    │   │   ├── profile.py
    │   │   ├── daily_logs.py
    │   │   ├── photos.py
    │   │   ├── cheat_meals.py
    │   │   └── feedback.py
    │   └── deps.py

    ├── domain/# business logic
    │   ├── feedback_engine.py
    │   ├── body_analysis.py
    │   └── trend_analysis.py

    ├── services/# external services
    │   ├── llm_service.py
    │   ├── image_analysis.py
    │   └── storage_service.py

    ├── workers/# async jobs
    │   └── tasks.py

    ├── db/
    │   ├──base.py
    │   ├── models.py
    │   ├── session.py
    │   └── migrations/

    ├── schemas/# Pydantic schemas
    │   ├── auth.py
    │   ├── profile.py
    │   ├── logs.py
    │   ├── photos.py
    │   └── feedback.py

```

---

## Data Model Summary

### Users

- Authentication-ready (JWT)
- Mono-user MVP, multi-user prepared

### Profile History

Profiles are **versioned**, not updated.

Each change in training context creates a new snapshot.

### Daily Logs

Daily records include:

- weight
- sleep (optional)
- training status
- calories (manual or estimated)
- notes

Logs can be added or edited retroactively.

### Cheat Meals

Cheat meals are qualitative inputs.

The system interprets **impact**, not exact intake.

### Photos

- Stored locally (MVP)
- Body fat is stored as a range
- Best physical state is user-confirmed
- Historical analysis is preserved

### Weekly Feedback

Generated on demand.

Stored and invalidated if underlying data changes.

### Jobs

All heavy processes are tracked through jobs with explicit states:

- pending
- processing
- done
- failed
- outdated (for invalidated feedback)

---

## Asynchronous Processing

AI-related operations are executed asynchronously:

- photo analysis
- cheat meal interpretation
- weekly feedback generation

Each operation:

1. Creates a job
2. Processes in background
3. Persists results
4. Updates job status

Requests are never blocked by long-running tasks.

---

## Weekly Feedback Flow

1. User requests weekly feedback
2. System validates week and existing feedback
3. A background job is created
4. Worker gathers:
    - weekly logs
    - relevant photos
    - cheat meals
    - latest profile snapshot
5. Deterministic metrics are calculated (before AI)
6. AI generates structured feedback
7. Feedback is stored and job is completed

If historical data changes, the feedback is marked as `outdated`.

---

## Use of AI

AI is used strictly for:

- estimating body fat ranges from images
- summarizing qualitative food inputs
- generating interpretive feedback

AI is **not** used for:

- medical advice
- diet prescriptions
- training plans
- decision-making logic

All AI outputs are treated as **non-authoritative estimates**.

Prompts are versioned and explicitly controlled.

---

## Authentication

- JWT-based authentication
- Mono-user MVP
- Architecture ready for Google OAuth integration

Authentication exists to demonstrate system design, not security depth.

---

## Explicit Non-Goals (V1)

- No macro tracking
- No training plans
- No medical metrics
- No notifications
- No automatic feedback generation

---

## Why This Architecture

This architecture prioritizes:

- clarity over cleverness
- explicit trade-offs
- scalability without overengineering
- explainability for both users and reviewers

The goal is to demonstrate **system design capability**, not feature volume.

---

## Next Steps

1. Implement database models
2. Implement domain logic without AI
3. Add async workers
4. Integrate AI services
5. Build minimal frontend
6. Deploy backend and frontend

---

## Cursor Agent Usage Guidelines

- Do not generate everything at once
- Follow build order:
    1. DB models
    2. Schemas
    3. Domain logic
    4. API routes
    5. Workers
- Do not mix layers
- Do not invent new naming conventions